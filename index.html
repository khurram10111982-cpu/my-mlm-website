<script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatrixMLM - TESTNET MODE</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-banner {
            background: #f59e0b;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .network-info {
            background: #e0f2fe;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
    </style>
</head>
<body>
    <div class="test-banner">
        üß™ TESTNET MODE ACTIVE | Contract: 0x019B57719039959E91cf4f6BFE424081CFD410d0
    </div>
    
    <div class="container">
        <div class="card">
            <h2>üöÄ MatrixMLM Platform - TESTNET</h2>
            
            <div class="network-info">
                <h4>üåê Network Status</h4>
                <p id="networkStatus">Checking network...</p>
                <p>Package Price: <strong>0.10 USDT</strong></p>
                <p>Contract: 0x019B57719039959E91cf4f6BFE424081CFD410d0</p>
            </div>

            <button class="btn btn-primary" onclick="connectWallet()" id="connectBtn">
                <i class="fas fa-plug"></i> Connect Wallet
            </button>

            <div id="appContent" style="display: none; margin-top: 20px;">
                <div style="margin: 15px 0;">
                    <label><strong>Upline Address (Optional)</strong></label>
                    <input type="text" id="uplineAddress" placeholder="0x..." style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px;">
                </div>
                
                <button class="btn btn-success" onclick="registerUser()" id="registerBtn">
                    <i class="fas fa-user-plus"></i> Register - 0.10 USDT
                </button>
                
                <div id="userInfo" style="margin-top: 20px; display: none;">
                    <h3>üìä Your Dashboard</h3>
                    <p>Earnings: <strong id="earnings">0</strong> USDT</p>
                    <p>Network Size: <strong id="networkSize">0</strong></p>
                    <p>Active: <strong id="userActive">No</strong></p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üß™ Test Results</h2>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        // ‚úÖ TESTNET CONFIGURATION - UPDATED
        const CONTRACT_ADDRESS = "0x019B57719039959E91cf4f6BFE424081CFD410d0";
        const USDT_ADDRESS = "0x337610d27c682E347C9cD60BD4b3b107C9d34dDd";
        
        // Contract ABI (Simplified)
        const CONTRACT_ABI = [
            {
                "inputs": [
                    {"internalType": "address", "name": "upline", "type": "address"}
                ],
                "name": "registerUser",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "user", "type": "address"}],
                "name": "getUser",
                "outputs": [
                    {"name": "upline", "type": "address"},
                    {"name": "totalEarnings", "type": "uint256"},
                    {"name": "networkSize", "type": "uint256"},
                    {"name": "active", "type": "bool"}
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const USDT_ABI = [
            {
                "constant": true,
                "inputs": [{"name": "who", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "", "type": "uint256"}],
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {"name": "_spender", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"name": "", "type": "bool"}],
                "type": "function"
            }
        ];

        let userAddress = '';

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // Switch to Testnet first
                    await switchToTestnet();
                    
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    
                    userAddress = accounts[0];
                    document.getElementById('networkStatus').innerHTML = 
                        '‚úÖ Connected to <strong>BSC Testnet</strong>';
                    document.getElementById('appContent').style.display = 'block';
                    document.getElementById('connectBtn').innerHTML = '<i class="fas fa-check"></i> Connected';
                    document.getElementById('connectBtn').style.background = 'var(--success)';
                    
                    await loadUserData();
                    await loadBalances();
                    
                    document.getElementById('testResults').innerHTML = 
                        '<div style="color: green;">‚úÖ Wallet connected successfully!</div>';
                    
                } catch (error) {
                    document.getElementById('testResults').innerHTML = 
                        `<div style="color: red;">‚ùå Error: ${error.message}</div>`;
                }
            } else {
                alert('Please install MetaMask!');
            }
        }

        async function switchToTestnet() {
            const BSC_TESTNET = {
                chainId: "0x61",
                chainName: "BSC Testnet",
                rpcUrls: ["https://data-seed-prebsc-1-s1.binance.org:8545/"],
                blockExplorerUrls: ["https://testnet.bscscan.com/"],
                nativeCurrency: {
                    name: "BNB",
                    symbol: "BNB",
                    decimals: 18
                }
            };

            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BSC_TESTNET.chainId }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [BSC_TESTNET],
                    });
                }
            }
        }

        async function loadUserData() {
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const userData = await contract.getUser(userAddress);
                
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('earnings').textContent = ethers.formatUnits(userData[1], 18);
                document.getElementById('networkSize').textContent = userData[2].toString();
                document.getElementById('userActive').textContent = userData[3] ? 'Yes' : 'No';
                
            } catch (error) {
                console.log('User not registered yet');
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userActive').textContent = 'No';
            }
        }

        async function loadBalances() {
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, provider);
                const usdtBalance = await usdtContract.balanceOf(userAddress);
                
                document.getElementById('testResults').innerHTML += 
                    `<div style="margin-top: 10px;">üí∞ USDT Balance: ${ethers.formatUnits(usdtBalance, 18)}</div>`;
                
            } catch (error) {
                console.log('Error loading balance');
            }
        }

        async function registerUser() {
            if (!userAddress) {
                alert('Please connect wallet first!');
                return;
            }

            const upline = document.getElementById('uplineAddress').value;
            const uplineAddress = upline || "0x0000000000000000000000000000000000000000";

            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // Check USDT balance
                const usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
                const balance = await usdtContract.balanceOf(userAddress);
                const requiredAmount = ethers.parseUnits("0.1", 18);
                
                if (balance < requiredAmount) {
                    alert('‚ùå Insufficient USDT. You need 0.10 USDT. Get from PancakeSwap Testnet.');
                    return;
                }
                
                // Approve USDT
                const allowance = await usdtContract.allowance(userAddress, CONTRACT_ADDRESS);
                if (allowance < requiredAmount) {
                    document.getElementById('testResults').innerHTML = 'üîÑ Approving USDT...';
                    const approveTx = await usdtContract.approve(CONTRACT_ADDRESS, requiredAmount);
                    await approveTx.wait();
                }
                
                document.getElementById('registerBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                document.getElementById('registerBtn').disabled = true;
                
                // Register user
                document.getElementById('testResults').innerHTML = 'üì§ Registering user...';
                const tx = await contract.registerUser(uplineAddress);
                
                document.getElementById('testResults').innerHTML = '‚è≥ Waiting for confirmation...';
                await tx.wait();
                
                document.getElementById('testResults').innerHTML = '<div style="color: green;">‚úÖ Registration successful!</div>';
                
                await loadUserData();
                
            } catch (error) {
                document.getElementById('testResults').innerHTML = 
                    `<div style="color: red;">‚ùå Error: ${error.message}</div>`;
            } finally {
                document.getElementById('registerBtn').innerHTML = '<i class="fas fa-user-plus"></i> Register - 0.10 USDT';
                document.getElementById('registerBtn').disabled = false;
            }
        }

        // Auto-connect on page load
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) {
                    userAddress = accounts[0].address;
                    document.getElementById('appContent').style.display = 'block';
                    document.getElementById('connectBtn').innerHTML = '<i class="fas fa-check"></i> Connected';
                    document.getElementById('connectBtn').style.background = 'var(--success)';
                    await loadUserData();
                }
            }
        });
    </script>
</body>
</html>

