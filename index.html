<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLM DApp - BSC Testnet</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #f0b90b;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .dapp-container {
            width: 100%;
            max-width: 450px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .dapp-header {
            background: var(--primary);
            padding: 25px;
            text-align: center;
            color: black;
        }
        
        .dapp-body {
            padding: 25px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--primary);
            color: black;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-card {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px 0;
        }
        
        .balance {
            font-size: 24px;
            font-weight: bold;
            color: var(--success);
            text-align: center;
            margin: 15px 0;
        }
        
        .dashboard {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .user-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="dapp-container">
        <div class="dapp-header">
            <h1>üöÄ MLM DApp v2.0</h1>
            <p>Powered by BSC Testnet | SafePal Ready</p>
        </div>
        
        <div class="dapp-body">
            <!-- Connection Status -->
            <div id="connectionStatus" class="status-card disconnected">
                üî¥ Not Connected
            </div>
            
            <!-- User Info -->
            <div id="userInfo" class="user-info" style="display: none;">
                <strong>Wallet:</strong> <span id="walletAddress"></span><br>
                <strong>Network:</strong> <span id="networkName"></span>
            </div>

            <!-- Action Buttons -->
            <button class="btn btn-primary" onclick="initializeDApp()">
                üåê 1. Initialize DApp
            </button>
            
            <button class="btn btn-primary" onclick="connectWallet()">
                üîó 2. Connect Wallet
            </button>

            <!-- Dashboard -->
            <div class="dashboard">
                <h3>üìä Your Dashboard</h3>
                <div class="balance" id="balance">0 BNB</div>
                <div style="text-align: center; margin: 10px 0;">
                    <strong>Network Size:</strong> <span id="networkSize">0</span>
                </div>
                <div style="text-align: center; margin: 10px 0;">
                    <strong>Earnings:</strong> <span id="earnings">0 USDT</span>
                </div>
                <div class="status-card" id="activeStatus" style="background: #f8d7da;">
                    Status: Not Registered
                </div>
            </div>
            
            <!-- Registration Section -->
            <h4>üë• Registration</h4>
            <input type="text" class="input-field" id="uplineAddress" 
                   placeholder="Upline Address (Optional - Leave empty for no upline)">
            
            <button class="btn btn-success" id="registerBtn" onclick="registerUser()" disabled>
                üí∞ Register - 0.10 USDT
            </button>

            <!-- Admin Functions -->
            <h4>üõ†Ô∏è Tools</h4>
            <button class="btn btn-primary" onclick="checkUserStatus()">
                üîç Check My Status
            </button>
            
            <button class="btn btn-danger" onclick="resetDApp()">
                üîÑ Reset Connection
            </button>

            <!-- Status Messages -->
            <div id="status" class="status-card info">
                Welcome! Click "Initialize DApp" to start.
            </div>
        </div>
    </div>

    <script>
        // DApp State
        let provider, signer, userAddress, contract;
        
        // Contract Configuration
        const CONTRACT_ADDRESS = "0x019B57719039959E91cf4f6BFE424081CFD410d0";
        const CONTRACT_ABI = [
            {
                "inputs": [{"internalType": "address", "name": "upline", "type": "address"}],
                "name": "register",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "user", "type": "address"}],
                "name": "getUser",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"},
                    {"internalType": "uint256", "name": "", "type": "uint256"},
                    {"internalType": "bool", "name": "", "type": "bool"}
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // BSC Testnet Configuration
        const BSC_CONFIG = {
            chainId: '0x61',
            chainName: 'BSC Testnet',
            nativeCurrency: {
                name: 'BNB',
                symbol: 'BNB',
                decimals: 18
            },
            rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
            blockExplorerUrls: ['https://testnet.bscscan.com/']
        };

        // Initialize DApp
        async function initializeDApp() {
            const status = document.getElementById('status');
            
            try {
                status.textContent = "üîÑ Initializing DApp...";
                
                // Check Web3 Provider
                if (typeof window.ethereum === 'undefined') {
                    throw new Error("Web3 provider not found. Please install MetaMask or SafePal.");
                }
                
                // Setup BSC Network
                status.textContent = "üîÑ Configuring BSC Testnet...";
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BSC_CONFIG.chainId }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [BSC_CONFIG]
                        });
                    }
                }
                
                // Initialize Provider
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                status.textContent = "‚úÖ DApp initialized successfully!";
                status.style.background = "#d4edda";
                
                document.getElementById('networkName').textContent = "BSC Testnet";
                
            } catch (error) {
                status.textContent = "‚ùå Initialization failed: " + error.message;
                status.style.background = "#f8d7da";
            }
        }

        // Connect Wallet
        async function connectWallet() {
            const status = document.getElementById('status');
            const connStatus = document.getElementById('connectionStatus');
            const userInfo = document.getElementById('userInfo');
            
            try {
                status.textContent = "üîÑ Connecting wallet...";
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts.length === 0) {
                    throw new Error("No accounts found. Please unlock your wallet.");
                }
                
                userAddress = accounts[0];
                
                // Update UI
                connStatus.textContent = "‚úÖ Connected to BSC Testnet";
                connStatus.className = "status-card connected";
                
                userInfo.style.display = 'block';
                document.getElementById('walletAddress').textContent = userAddress.substring(0, 10) + '...' + userAddress.substring(38);
                
                // Get Balance
                const balance = await provider.getBalance(userAddress);
                const bnbBalance = ethers.utils.formatEther(balance);
                document.getElementById('balance').textContent = parseFloat(bnbBalance).toFixed(6) + " BNB";
                
                // Enable register button
                document.getElementById('registerBtn').disabled = false;
                
                status.textContent = "‚úÖ Wallet connected successfully! Ready to register.";
                status.style.background = "#d4edda";
                
            } catch (error) {
                status.textContent = "‚ùå Connection failed: " + error.message;
                status.style.background = "#f8d7da";
            }
        }

        // Register User
        async function registerUser() {
            const status = document.getElementById('status');
            const activeStatus = document.getElementById('activeStatus');
            
            try {
                status.textContent = "üîÑ Processing registration...";
                status.style.background = "#fff3cd";
                
                const uplineAddress = document.getElementById('uplineAddress').value.trim() || 
                                    "0x0000000000000000000000000000000000000000";
                
                // Validate upline address if provided
                if (uplineAddress !== "0x0000000000000000000000000000000000000000") {
                    if (!ethers.utils.isAddress(uplineAddress)) {
                        throw new Error("Invalid upline address format");
                    }
                }
                
                // Create contract instance
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // Execute registration
                // Note: Adjust value according to your contract requirements
                const tx = await contract.register(uplineAddress, {
                    value: ethers.utils.parseEther("0.0"), // Change to actual amount if needed
                    gasLimit: 300000
                });
                
                status.textContent = "‚è≥ Transaction submitted. Waiting for confirmation...";
                
                // Wait for transaction confirmation
                const receipt = await tx.wait();
                
                status.textContent = "‚úÖ Registration successful!";
                status.style.background = "#d4edda";
                
                // Update UI
                activeStatus.textContent = "Status: Registered ‚úÖ";
                activeStatus.style.background = "#d4edda";
                document.getElementById('networkSize').textContent = "1";
                
                console.log("Transaction receipt:", receipt);
                
            } catch (error) {
                status.textContent = "‚ùå Registration failed: " + error.message;
                status.style.background = "#f8d7da";
                console.error("Registration error:", error);
            }
        }

        // Check User Status
        async function checkUserStatus() {
            const status = document.getElementById('status');
            
            try {
                status.textContent = "üîç Checking user status...";
                status.style.background = "#fff3cd";
                
                if (!contract && provider) {
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                }
                
                if (contract && userAddress) {
                    // Simulate status check - replace with actual contract call
                    setTimeout(() => {
                        status.textContent = "‚úÖ Status check complete - User is registered";
                        status.style.background = "#d4edda";
                    }, 1500);
                } else {
                    status.textContent = "‚ö†Ô∏è Please connect wallet first";
                    status.style.background = "#fff3cd";
                }
                
            } catch (error) {
                status.textContent = "‚ùå Status check failed: " + error.message;
                status.style.background = "#f8d7da";
            }
        }

        // Reset DApp
        function resetDApp() {
            window.location.reload();
        }

        // Event Listeners
        window.addEventListener('load', function() {
            // Auto-initialize if Web3 detected
            if (typeof window.ethereum !== 'undefined') {
                setTimeout(initializeDApp, 1000);
            }
        });

        // Handle account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    connectWallet();
                } else {
                    document.getElementById('connectionStatus').textContent = "üî¥ Not Connected";
                    document.getElementById('connectionStatus').className = "status-card disconnected";
                    document.getElementById('userInfo').style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
