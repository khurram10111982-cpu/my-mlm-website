<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MLM System</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #f0b90b;
            --secondary: #1a1a1a;
            --success: #00a86b;
            --sidebar: #2c3e50;
            --card-bg: #ffffff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f8f9fa;
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--sidebar);
            color: white;
            padding: 20px 0;
        }
        
        .logo {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 20px;
        }
        
        .logo h2 {
            color: var(--primary);
            font-size: 24px;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .nav-item:hover, .nav-item.active {
            background: #34495e;
            border-left: 4px solid var(--primary);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: black;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--secondary);
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        /* Referral Section */
        .referral-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .referral-link {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            word-break: break-all;
            font-family: monospace;
        }
        
        /* Matrix Section */
        .matrix-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .matrix-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .matrix-cell {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #dee2e6;
        }
        
        .matrix-cell.filled {
            background: #d4edda;
            border-color: #28a745;
        }
        
        /* Income Distribution */
        .distribution-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .distribution-chart {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .distribution-item {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .matrix-dist { background: #d4edda; }
        .unilevel-dist { background: #d1ecf1; }
        .rank-dist { background: #fff3cd; }
        .company-dist { background: #f8d7da; }
        
        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: black;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-block {
            width: 100%;
            padding: 15px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h2>üöÄ MLM PRO</h2>
        </div>
        <ul class="nav-menu">
            <li class="nav-item active" onclick="showTab('dashboard')">
                üìä Dashboard
            </li>
            <li class="nav-item" onclick="showTab('matrix')">
                üî¢ Matrix
            </li>
            <li class="nav-item" onclick="showTab('unilevel')">
                üå≥ Unilevel
            </li>
            <li class="nav-item" onclick="showTab('income')">
                üí∞ Income
            </li>
            <li class="nav-item" onclick="showTab('team')">
                üë• My Team
            </li>
            <li class="nav-item" onclick="logout()">
                üö™ Logout
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">USER</div>
                <div>
                    <h3>Welcome, <span id="userName">User</span>!</h3>
                    <p>User ID: <span id="userId">TEAM008</span> | Rank: <span id="userRank">Silver</span></p>
                </div>
            </div>
            <div>
                <button class="btn btn-primary" onclick="registerUser()">‚úÖ Register in Contract</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalTeam">0</div>
                    <div class="stat-label">Total Team</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="directTeam">0</div>
                    <div class="stat-label">Direct Team</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalEarnings">0 USDT</div>
                    <div class="stat-label">Total Earnings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="matrixComplete">0/5</div>
                    <div class="stat-label">Matrix Completion</div>
                </div>
            </div>

            <!-- Referral Section -->
            <div class="referral-section">
                <h3>üîó Your Referral Link</h3>
                <div class="referral-link" id="referralLink">
                    Loading...
                </div>
                <button class="btn btn-success btn-block" onclick="copyReferralLink()">
                    üìã Copy Referral Link
                </button>
            </div>

            <!-- Quick Actions -->
            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="showTab('matrix')">
                    <div class="stat-value">üî¢</div>
                    <div class="stat-label">View Matrix</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showTab('unilevel')">
                    <div class="stat-value">üå≥</div>
                    <div class="stat-label">Unilevel Tree</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showTab('income')">
                    <div class="stat-value">üí∞</div>
                    <div class="stat-label">Income Report</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showTab('team')">
                    <div class="stat-value">üë•</div>
                    <div class="stat-label">Team Management</div>
                </div>
            </div>
        </div>

        <!-- Matrix Tab -->
        <div id="matrix" class="tab-content">
            <div class="matrix-section">
                <h2>üî¢ Matrix System (5 Members to Complete)</h2>
                <div class="matrix-grid">
                    <div class="matrix-cell filled">
                        <div>Slot 1</div>
                        <div class="stat-value">‚úÖ</div>
                        <div>Filled</div>
                    </div>
                    <div class="matrix-cell filled">
                        <div>Slot 2</div>
                        <div class="stat-value">‚úÖ</div>
                        <div>Filled</div>
                    </div>
                    <div class="matrix-cell">
                        <div>Slot 3</div>
                        <div class="stat-value">‚ùå</div>
                        <div>Empty</div>
                    </div>
                    <div class="matrix-cell">
                        <div>Slot 4</div>
                        <div class="stat-value">‚ùå</div>
                        <div>Empty</div>
                    </div>
                    <div class="matrix-cell">
                        <div>Slot 5</div>
                        <div class="stat-value">‚ùå</div>
                        <div>Empty</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <div class="stat-value">2/5</div>
                    <div>Matrix Completion Progress</div>
                    <div class="stat-label">3 more members needed to complete matrix</div>
                </div>
            </div>
        </div>

        <!-- Unilevel Tab -->
        <div id="unilevel" class="tab-content">
            <div class="referral-section">
                <h2>üå≥ Unilevel Income & Tree</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="level1Income">0 USDT</div>
                        <div class="stat-label">Level 1 Income</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="level2Income">0 USDT</div>
                        <div class="stat-label">Level 2 Income</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="level3Income">0 USDT</div>
                        <div class="stat-label">Level 3 Income</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalUnilevel">0 USDT</div>
                        <div class="stat-label">Total Unilevel</div>
                    </div>
                </div>
                
                <h3>Unilevel Tree Structure</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-weight: bold; margin: 10px 0;">üéØ YOU (Level 0)</div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                        <div style="text-align: center;">
                            <div>üë§ Level 1</div>
                            <div><small>Member A</small></div>
                        </div>
                        <div style="text-align: center;">
                            <div>üë§ Level 1</div>
                            <div><small>Member B</small></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Income Tab -->
        <div id="income" class="tab-content">
            <div class="distribution-section">
                <h2>üí∞ Fund Distribution</h2>
                <div class="distribution-chart">
                    <div class="distribution-item matrix-dist">
                        <div class="stat-value">40%</div>
                        <div class="stat-label">Matrix Income</div>
                        <div id="matrixIncome">0 USDT</div>
                    </div>
                    <div class="distribution-item unilevel-dist">
                        <div class="stat-value">48%</div>
                        <div class="stat-label">Unilevel Income</div>
                        <div id="unilevelIncome">0 USDT</div>
                    </div>
                    <div class="distribution-item rank-dist">
                        <div class="stat-value">1%</div>
                        <div class="stat-label">Rank & Rewards</div>
                        <div id="rankIncome">0 USDT</div>
                    </div>
                    <div class="distribution-item company-dist">
                        <div class="stat-value">11%</div>
                        <div class="stat-label">Company</div>
                        <div id="companyIncome">0 USDT</div>
                    </div>
                </div>
                
                <h3>Total Income: <span id="totalIncome">0 USDT</span></h3>
                <button class="btn btn-success btn-block" onclick="withdrawIncome()">
                    üí∏ Withdraw All Income
                </button>
            </div>
        </div>

        <!-- Team Tab -->
        <div id="team" class="tab-content">
            <div class="referral-section">
                <h2>üë• My Team Management</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="directMembers">0</div>
                        <div class="stat-label">Direct Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalMembers">0</div>
                        <div class="stat-label">Total Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeMembers">0</div>
                        <div class="stat-label">Active Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="teamEarnings">0 USDT</div>
                        <div class="stat-label">Team Earnings</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0x019B57719039959E91cf4f6BFE424081CFD410d0";
        const CONTRACT_ABI = [
            "function register(address upline) external payable",
            "function getUser(address user) external view returns (uint256, uint256, bool)",
            "function getEarnings(address user) external view returns (uint256)",
            "function directReferrals(address user) external view returns (uint256)",
            "function totalTeam(address user) external view returns (uint256)",
            "function withdraw() external"
        ];

        let provider, signer, userAddress, contract;

        // Check if user is connected
        window.addEventListener('load', function() {
            const savedAddress = localStorage.getItem('userAddress');
            const isConnected = localStorage.getItem('walletConnected');
            
            if (!isConnected || !savedAddress) {
                window.location.href = 'index.html';
                return;
            }
            
            userAddress = savedAddress;
            initializeDashboard();
            connectContract();
        });

        // Initialize Dashboard
        function initializeDashboard() {
            // Set user info
            document.getElementById('userAvatar').textContent = userAddress.substring(2, 6).toUpperCase();
            document.getElementById('userName').textContent = 'User ' + userAddress.substring(2, 6);
            document.getElementById('userId').textContent = 'USER_' + userAddress.substring(2, 8);
            
            // Set referral link
            document.getElementById('referralLink').textContent = 
                window.location.origin + '/index.html?ref=' + userAddress;
        }

        // Connect to Contract
        async function connectContract() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // Load contract data
                await loadContractData();
                
            } catch (error) {
                console.error("Contract connection failed:", error);
            }
        }

        // Load data from contract
        async function loadContractData() {
            try {
                if (!contract) return;

                // Get user data from contract
                const userData = await contract.getUser(userAddress);
                const directRefs = await contract.directReferrals(userAddress);
                const totalTeamCount = await contract.totalTeam(userAddress);
                const earnings = await contract.getEarnings(userAddress);

                // Update dashboard
                document.getElementById('directTeam').textContent = directRefs.toString();
                document.getElementById('totalTeam').textContent = totalTeamCount.toString();
                document.getElementById('directMembers').textContent = directRefs.toString();
                document.getElementById('totalMembers').textContent = totalTeamCount.toString();
                document.getElementById('activeMembers').textContent = totalTeamCount.toString();

                // Convert earnings to USDT
                const earningsUSDT = ethers.utils.formatUnits(earnings, 6);
                const earningsNum = parseFloat(earningsUSDT);
                
                document.getElementById('totalEarnings').textContent = earningsNum.toFixed(2) + " USDT";
                document.getElementById('teamEarnings').textContent = earningsNum.toFixed(2) + " USDT";
                document.getElementById('totalIncome').textContent = earningsNum.toFixed(2) + " USDT";

                // Calculate distribution
                document.getElementById('matrixIncome').textContent = (earningsNum * 0.40).toFixed(2) + " USDT";
                document.getElementById('unilevelIncome').textContent = (earningsNum * 0.48).toFixed(2) + " USDT";
                document.getElementById('rankIncome').textContent = (earningsNum * 0.01).toFixed(2) + " USDT";
                document.getElementById('companyIncome').textContent = (earningsNum * 0.11).toFixed(2) + " USDT";

                // Matrix completion
                const matrixComplete = Math.min(directRefs.toNumber(), 5);
                document.getElementById('matrixComplete').textContent = matrixComplete + '/5';

                // Unilevel income
                document.getElementById('level1Income').textContent = (earningsNum * 0.25).toFixed(2) + " USDT";
                document.getElementById('level2Income').textContent = (earningsNum * 0.15).toFixed(2) + " USDT";
                document.getElementById('level3Income').textContent = (earningsNum * 0.08).toFixed(2) + " USDT";
                document.getElementById('totalUnilevel').textContent = (earningsNum * 0.48).toFixed(2) + " USDT";

            } catch (error) {
                console.error("Error loading contract data:", error);
            }
        }

        // Register User in Contract
        async function registerUser() {
            try {
                if (!contract) {
                    alert("Please wait for contract connection...");
                    return;
                }

                const tx = await contract.register("0x0000000000000000000000000000000000000000", {
                    value: ethers.utils.parseEther("0.00"),
                    gasLimit: 300000
                });

                alert("Registration transaction submitted!");
                await tx.wait();
                alert("Registration successful!");
                
                // Reload data
                await loadContractData();
                
            } catch (error) {
                alert("Registration failed: " + error.message);
            }
        }

        // Copy Referral Link
        function copyReferralLink() {
            const link = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(link);
            alert("‚úÖ Referral link copied!");
        }

        // Withdraw Income
        async function withdrawIncome() {
            try {
                if (!contract) {
                    alert("Contract not connected!");
                    return;
                }

                const tx = await contract.withdraw({
                    gasLimit: 200000
                });
                
                alert("Withdrawal transaction submitted!");
                await tx.wait();
                alert("Withdrawal successful!");
                
                // Reload data
                await loadContractData();
                
            } catch (error) {
                alert("Withdrawal failed: " + error.message);
            }
        }

        // Tab Navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Activate selected nav item
            event.target.classList.add('active');
        }

        // Logout
        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem('userAddress');
                localStorage.removeItem('walletConnected');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
