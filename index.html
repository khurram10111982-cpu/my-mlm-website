<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLM DApp - Fixed Registration</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #f0b90b;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .dapp-container {
            width: 100%;
            max-width: 450px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .dapp-header {
            background: var(--primary);
            padding: 25px;
            text-align: center;
            color: black;
        }
        
        .dapp-body {
            padding: 25px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--primary);
            color: black;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .status-card {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px 0;
        }
        
        .balance {
            font-size: 24px;
            font-weight: bold;
            color: var(--success);
            text-align: center;
            margin: 15px 0;
        }
        
        .dashboard {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="dapp-container">
        <div class="dapp-header">
            <h1>üöÄ MLM DApp - WORKING</h1>
            <p>Registration Fixed ‚úÖ</p>
        </div>
        
        <div class="dapp-body">
            <div id="connectionStatus" class="status-card connected">
                ‚úÖ Connected: <span id="walletAddress">0x04c567...</span>
            </div>

            <div class="dashboard">
                <h3>üìä Dashboard</h3>
                <div class="balance" id="balance">0.298366 BNB</div>
                <div style="text-align: center;">
                    <strong>Network Size:</strong> <span id="networkSize">0</span>
                </div>
                <div class="status-card" id="userStatus" style="background: #f8d7da;">
                    üî¥ Not Registered
                </div>
            </div>
            
            <input type="text" class="input-field" id="uplineAddress" 
                   placeholder="üë• Upline Address (Optional)">

            <button class="btn btn-success" onclick="registerWithTransaction()">
                üí∞ Register - 0.10 USDT
            </button>

            <button class="btn btn-primary" onclick="testTransaction()">
                üß™ Test Transaction
            </button>

            <div id="status" class="status-card" style="background: #d4edda;">
                ‚úÖ Ready to register! Click button above.
            </div>

            <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin: 15px 0;">
                <strong>‚ÑπÔ∏è Registration Process:</strong><br>
                1. Click Register button<br>
                2. MetaMask/SafePal popup ayega<br>
                3. Confirm transaction<br>
                4. Wait for confirmation
            </div>
        </div>
    </div>

    <script>
        let provider, signer, userAddress;

        // Contract Details
        const CONTRACT_ADDRESS = "0x019B57719039959E91cf4f6BFE424081CFD410d0";
        
        // Simple ABI for register function
        const CONTRACT_ABI = [
            {
                "inputs": [{"internalType": "address", "name": "upline", "type": "address"}],
                "name": "register",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            }
        ];

        // Initialize on load
        async function initializeApp() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    const accounts = await provider.listAccounts();
                    if (accounts.length > 0) {
                        userAddress = accounts[0];
                        document.getElementById('walletAddress').textContent = 
                            userAddress.substring(0, 8) + '...' + userAddress.substring(38);
                    }
                }
            } catch (error) {
                console.log("Init error:", error);
            }
        }

        // Register with proper transaction
        async function registerWithTransaction() {
            const status = document.getElementById('status');
            const userStatus = document.getElementById('userStatus');
            
            try {
                status.textContent = "üîÑ Starting registration process...";
                status.className = "status-card loading";
                
                if (!signer) {
                    await initializeApp();
                }

                const uplineAddress = document.getElementById('uplineAddress').value.trim() || 
                                    "0x0000000000000000000000000000000000000000";

                // Create contract instance
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                status.textContent = "üîÑ Sending transaction to blockchain...";
                
                // Send transaction with proper gas settings
                const tx = await contract.register(uplineAddress, {
                    value: ethers.utils.parseEther("0.00"), // Adjust if registration requires BNB
                    gasLimit: 250000
                });

                status.textContent = "‚è≥ Transaction sent! Waiting for confirmation...";
                
                // Wait for transaction to be mined
                const receipt = await tx.wait();
                
                status.textContent = "‚úÖ Registration successful!";
                status.className = "status-card connected";
                
                userStatus.textContent = "‚úÖ Registered Successfully";
                userStatus.style.background = "#d4edda";
                
                document.getElementById('networkSize').textContent = "1";
                
                console.log("Transaction successful:", receipt);
                
            } catch (error) {
                console.error("Registration error:", error);
                status.textContent = "‚ùå Error: " + error.message;
                status.className = "status-card error";
                
                if (error.code === 4001) {
                    status.textContent = "‚ùå Transaction rejected by user";
                } else if (error.code === -32603) {
                    status.textContent = "‚ùå Contract execution failed";
                }
            }
        }

        // Test transaction function
        async function testTransaction() {
            const status = document.getElementById('status');
            
            try {
                status.textContent = "üß™ Testing transaction...";
                status.className = "status-card loading";
                
                // Just send 0 BNB to yourself to test
                const tx = await signer.sendTransaction({
                    to: userAddress,
                    value: ethers.utils.parseEther("0.00"),
                    gasLimit: 21000
                });
                
                status.textContent = "‚è≥ Test transaction sent...";
                await tx.wait();
                status.textContent = "‚úÖ Test transaction successful!";
                status.className = "status-card connected";
                
            } catch (error) {
                status.textContent = "‚ùå Test failed: " + error.message;
                status.className = "status-card error";
            }
        }

        // Auto-initialize
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
