<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MLM System</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #f0b90b; --sidebar: #2c3e50; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial; }
        body { background: #f8f9fa; display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: var(--sidebar); color: white; padding: 20px 0; }
        .logo { text-align: center; padding: 20px; border-bottom: 1px solid #34495e; margin-bottom: 20px; }
        .nav-item { padding: 15px 25px; cursor: pointer; border-left: 4px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #34495e; border-left: 4px solid var(--primary); }
        .main-content { flex: 1; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; text-align: center; border-top: 4px solid var(--primary); }
        .stat-value { font-size: 32px; font-weight: bold; color: #333; margin: 10px 0; }
        .btn { padding: 12px 20px; background: var(--primary); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo"><h2>🚀 MLM PRO</h2></div>
        <div class="nav-item active" onclick="showTab('dashboard')">📊 Dashboard</div>
        <div class="nav-item" onclick="showTab('matrix')">🔢 Matrix</div>
        <div class="nav-item" onclick="showTab('unilevel')">🌳 Unilevel</div>
        <div class="nav-item" onclick="showTab('income')">💰 Income</div>
        <div class="nav-item" onclick="logout()">🚪 Logout</div>
    </div>

    <div class="main-content">
        <div class="header">
            <h3>Welcome, <span id="userName">User</span>!</h3>
            <button class="btn" onclick="registerUser()">✅ Register in Contract</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalTeam">0</div>
                    <div>Total Team</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="directTeam">0</div>
                    <div>Direct Team</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalEarnings">0 USDT</div>
                    <div>Total Earnings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="matrixComplete">0/5</div>
                    <div>Matrix Complete</div>
                </div>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 15px; margin: 20px 0;">
                <h3>🔗 Your Referral Link</h3>
                <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin: 10px 0;">
                    <span id="referralLink">Loading...</span>
                </div>
                <button class="btn" onclick="copyReferralLink()">📋 Copy Link</button>
            </div>
        </div>

        <div id="matrix" class="tab-content">
            <h2>🔢 Matrix System (5 Members Required)</h2>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; text-align: center;">Slot 1 ✅</div>
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; text-align: center;">Slot 2 ✅</div>
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; text-align: center;">Slot 3 ❌</div>
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; text-align: center;">Slot 4 ❌</div>
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; text-align: center;">Slot 5 ❌</div>
            </div>
            <p>Progress: <strong>2/5</strong> - 3 more needed</p>
        </div>

        <div id="unilevel" class="tab-content">
            <h2>🌳 Unilevel Income</h2>
            <div class="stats-grid">
                <div class="stat-card">Level 1: <div class="stat-value">0 USDT</div></div>
                <div class="stat-card">Level 2: <div class="stat-value">0 USDT</div></div>
                <div class="stat-card">Level 3: <div class="stat-value">0 USDT</div></div>
                <div class="stat-card">Total: <div class="stat-value">0 USDT</div></div>
            </div>
        </div>

        <div id="income" class="tab-content">
            <h2>💰 Income Distribution</h2>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">Matrix: 40%<br>0 USDT</div>
                <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; text-align: center;">Unilevel: 48%<br>0 USDT</div>
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">Rank: 1%<br>0 USDT</div>
                <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">Company: 11%<br>0 USDT</div>
            </div>
            <button class="btn" onclick="withdrawIncome()">💸 Withdraw Income</button>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0x019B57719039959E91cf4f6BFE424081CFD410d0";
        let userAddress, contract;

        // Check login
        window.addEventListener('load', function() {
            if (!localStorage.getItem('walletConnected')) {
                window.location.href = 'index.html';
                return;
            }
            userAddress = localStorage.getItem('userAddress');
            initializeDashboard();
            connectContract();
        });

        function initializeDashboard() {
            document.getElementById('userName').textContent = 'User ' + userAddress.substring(2, 6);
            document.getElementById('referralLink').textContent = window.location.origin + '?ref=' + userAddress;
        }

        async function connectContract() {
            if (typeof window.ethereum === 'undefined') return;
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, [
                "function register(address upline) external payable",
                "function getUser(address user) external view returns (uint256, uint256, bool)",
                "function getEarnings(address user) external view returns (uint256)",
                "function directReferrals(address user) external view returns (uint256)",
                "function withdraw() external"
            ], signer);
            await loadContractData();
        }

        async function loadContractData() {
            if (!contract) return;
            try {
                const userData = await contract.getUser(userAddress);
                const directRefs = await contract.directReferrals(userAddress);
                const earnings = await contract.getEarnings(userAddress);
                
                document.getElementById('directTeam').textContent = directRefs.toString();
                document.getElementById('totalTeam').textContent = directRefs.toString();
                document.getElementById('matrixComplete').textContent = Math.min(directRefs.toNumber(), 5) + '/5';
                
                const earningsUSDT = parseFloat(ethers.utils.formatUnits(earnings, 6));
                document.getElementById('totalEarnings').textContent = earningsUSDT.toFixed(2) + " USDT";
            } catch (error) {
                console.log("Data load error:", error);
            }
        }

        async function registerUser() {
            if (!contract) return alert("Connect wallet first!");
            try {
                const tx = await contract.register("0x0000000000000000000000000000000000000000", {
                    value: ethers.utils.parseEther("0.00")
                });
                alert("Registration submitted!");
                await tx.wait();
                alert("Registered successfully!");
                await loadContractData();
            } catch (error) {
                alert("Error: " + error.message);
            }
        }

        function copyReferralLink() {
            navigator.clipboard.writeText(document.getElementById('referralLink').textContent);
            alert("✅ Link copied!");
        }

        async function withdrawIncome() {
            if (!contract) return alert("Connect wallet first!");
            try {
                const tx = await contract.withdraw();
                alert("Withdrawal submitted!");
                await tx.wait();
                alert("Withdrawal successful!");
                await loadContractData();
            } catch (error) {
                alert("Error: " + error.message);
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>